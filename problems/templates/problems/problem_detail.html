{% extends 'base.html' %}
{% load markdownify %}
{% load static %}


{% block title %}{{ problem.name }} â€“ CodeVerse{% endblock %}

{% block content %}
<style>
  .split-container {
    display: flex;
    height: calc(100vh - 100px);
    overflow: hidden;
  }
  .left-pane {
    width: 40%;
    min-width: 300px;
    max-width: 70%;
    padding: 1rem;
    overflow-y: auto;

    /* ğŸ”¹ Add space between left pane and resizer */
    margin-right: 8px;
    box-sizing: border-box;
  }
  .right-pane {
    flex-grow: 1;
    padding: 1rem;
    overflow-y: auto;
  }

  /* ğŸ”¹ Sleek blue, dotted vertical splitter */
  .resizer {
    width: 4px;
    cursor: ew-resize;
    background-color: #1a2b4c;
    background-image: radial-gradient(circle, #4da6ff 1px, transparent 1px);
    background-size: 2px 6px;
    background-repeat: repeat-y;
    transition: background-color .2s, transform .2s;
  }
  .resizer:hover {
    background-color: #263b6e;
    transform: scaleX(1.1);
  }

  #editor {
    height: 300px;
    border: 1px solid #007bff;
    border-radius: .5rem;
  }

  /* scrollbars */
  .left-pane::-webkit-scrollbar,
  .right-pane::-webkit-scrollbar {
    width: 6px;
  }
  .left-pane::-webkit-scrollbar-thumb,
  .right-pane::-webkit-scrollbar-thumb {
    background-color: #4da6ff;
    border-radius: 3px;
  }

  /* custom-input styling */
  #custom-input {
    background: #fff;
    color: #000;
  }
  #custom-input::placeholder {
    color: #666;
    opacity: 1;
  }
  /* Monaco scrollbar styling */
  .monaco-scrollable-element > .scrollbar > .slider {
    background: #4da6ff !important;
    border-radius: 3px !important;
  }

  /* Monaco draggers (sashes) - usually invisible unless in split editor mode */
  .monaco-sash {
    width: 3px !important;
    height: 3px !important;
    background: transparent !important;
  }
  .monaco-sash:hover {
    background: #4da6ff !important;
    opacity: 0.5 !important;
  }

  .markdown-body {
    background: transparent;
    color: #cbd5e1;
    font-size: 15px;
    line-height: 1.6;
  }
  .markdown-body pre {
    background: #0e1c2e;
    padding: 0.75rem;
    border-radius: 0.5rem;
    overflow-x: auto;
  }
  .markdown-body code {
    background: #162d4d;
    padding: 0.15em 0.4em;
    border-radius: 0.3rem;
  }


  pre {
    background-color: #0d1117;
    color: #e2e8f0;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
    overflow-x: auto;
    white-space: pre-wrap; /* âœ… Wrap lines instead of horizontal scroll */
    word-wrap: break-word;
    margin: 0;
  }

  /* Remove vertical scale weirdness */
  .mb-3 pre {
    max-height: none;
    overflow-y: hidden;
  }

  .preserve-linebreaks {
    white-space: pre-line; /* ğŸ”¥ keeps newlines */
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
    background-color: #0d1117;
    color: #e2e8f0;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    line-height: 1.6;
    overflow-x: auto;
  }
  

  

</style>

<div class="mb-3">
  <a href="{% url 'problem_list' %}" class="btn btn-outline-secondary">
    â† Back to Problems
  </a>
</div>

<div class="split-container">
  <!-- Problem description -->
  <div class="left-pane">
    <div class="problem-card markdown-body">
      <div class="problem-card-title">ğŸ§  {{ problem.name }}</div>
      <div class="problem-card-meta mb-3 d-flex flex-wrap gap-3 align-items-center">
        <div>
          <strong>Code:</strong> <code>{{ problem.code }}</code>
        </div>
      
        <div>
          <strong>Difficulty:</strong>
          <span class="badge 
            {% if problem.difficulty == 'Easy' %}bg-success text-light
            {% elif problem.difficulty == 'Medium' %}bg-warning text-dark
            {% elif problem.difficulty == 'Hard' %}bg-danger text-light
            {% else %}bg-secondary text-light{% endif %}">
            {{ problem.get_difficulty_display }}
          </span>
        </div>
      
        <div>
          <strong>Time Limit:</strong>
          <span class="badge bg-info text-dark">
            {{ problem.time_limit }} seconds
          </span>
        </div>
      
        <div>
          <strong>Memory Limit:</strong>
          <span class="badge bg-info text-dark">
            {{ problem.memory_limit }} MB
          </span>
        </div>
      </div>
      
  
      <div class="mb-3">
        <h5 class="text-info">ğŸ“ Description</h5>
        <div class="markdown-body">{{ problem.description|safe }}</div>
      </div>
      
      <div class="mb-3">
        <h5 class="text-info">ğŸ”½ Input Format</h5>
        <div class="markdown-body">{{ problem.input_format|safe }}</div>
      </div>
      
      <div class="mb-3">
        <h5 class="text-info">ğŸ”¼ Output Format</h5>
        <div class="markdown-body">{{ problem.output_format|safe }}</div>
      </div>
      
      <div class="mb-3">
        <h5 class="text-info">ğŸ“Œ Constraints</h5>
        <div class="markdown-body">{{ problem.constraints|safe }}</div>
      </div>
      
      <div class="mb-3">
        <h5 class="text-info">ğŸ”‚ Sample Input</h5>
        <div class="markdown-body">{{ problem.sample_input|safe }}</div>
      </div>
      
      <div class="mb-3">
        <h5 class="text-info">ğŸ” Sample Output</h5>
        <div class="markdown-body">{{ problem.sample_output|safe }}</div>
      </div>
      
      
    </div>
  </div>
  

  <!-- the one, thin vertical splitter -->
  <div class="resizer" id="resizer"></div>

  <!-- Code workspace -->
  <div class="right-pane">
    <div class="problem-card">
      <div class="problem-card-title">ğŸš€ Code Workspace</div>
      <form id="submission-form" method="post">
        {% csrf_token %}
        <div class="mb-2">
          <label>Language:</label>
          <select name="language" id="language"
                  class="form-select w-auto d-inline-block ms-2">
                  <option value="cpp">C++</option>
                  <option value="python">Python</option>
                  <option value="java">Java</option>
                  <option value="c">C</option>
          </select>
        </div>
        <div class="mb-3">
          <label>Your Code:</label>
          <div id="editor"></div>
          <textarea name="code" id="hidden-code" hidden></textarea>
        </div>
        <div class="mb-2">
          <label>ğŸ“¥ Custom Input:</label>
          <textarea id="custom-input" class="form-control"
                    rows="3" placeholder="Enter custom inputâ€¦"></textarea>
        </div>
        <div class="mb-2">
          <label>ğŸ“¤ Output:</label>
          <textarea id="custom-output" class="form-control"
                    rows="4" readonly></textarea>
        </div>
        <div class="d-flex gap-3">
          <button type="button" class="btn btn-outline-primary"
                  id="run-button">â–¶ï¸ Run Code</button>
          <button type="submit" class="btn btn-success">âœ… Submit</button>
        </div>
      </form>
    </div>
  </div>


</div>

<!-- Monaco AMD Loader (must come before monaco-setup.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>


<script src="{% static 'js/monaco-setup.js' %}"></script>
<script>
  setupMonacoEditor({
    selector: "editor",
    language: "cpp",
    theme: "one-dark-pro",
    onReady: (editor, monaco) => {
      const boilerplate = {
        java: `import java.util.*;\n\npublic class Main {\n    public static void main(String[] args) {\n        // Your code here\n\n\n    }\n}`,
        python: `def main():\n    # Your code here\n\n\n    pass\n\nif __name__ == "__main__":\n    main()`,
        cpp: `#include <bits/stdc++.h>\nusing namespace std;\n\nint main() {\n    ios::sync_with_stdio(false);\n    cin.tie(nullptr);\n    // Your code here\n\n\n    return 0;\n}`,
        c: `#include <stdio.h>\n\nint main() {\n    // Your code here\n\n\n    return 0;\n}`
      };

      const langSel = document.getElementById("language");
      langSel.addEventListener("change", () => {
        const lang = langSel.value;
        editor.setValue(boilerplate[lang] || "");
        monaco.editor.setModelLanguage(editor.getModel(), lang === "cpp" ? "cpp" : lang);
      });
      langSel.dispatchEvent(new Event("change"));

      document.getElementById("run-button").addEventListener("click", () => {
        const data = new FormData();
        data.append("code", editor.getValue());
        data.append("language", langSel.value);
        data.append("custom_input", document.getElementById("custom-input").value);

        fetch("{% url 'run_code' %}", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          body: data
        })
        .then(res => res.json())
        .then(json => {
          document.getElementById("custom-output").value =
            json.output || json.details || json.error || "";
        });
      });

      document.getElementById("submission-form").addEventListener("submit", () => {
        document.getElementById("hidden-code").value = editor.getValue();
      });
    }
  });

  // vertical splitter
  const rz = document.getElementById("resizer"),
        lp = rz.previousElementSibling;
  let dragging = false;
  rz.onmousedown = () => { dragging = true; document.body.style.cursor = "ew-resize"; };
  document.onmousemove = e => {
    if (!dragging) return;
    let newW = e.clientX - lp.parentNode.offsetLeft;
    if (newW > 250 && newW < window.innerWidth * 0.7) {
      lp.style.width = newW + "px";
    }
  };
  document.onmouseup = () => { dragging = false; document.body.style.cursor = ""; };
</script>

{% endblock %}
