{% extends 'base.html' %}
{% load markdownify %}
{% load static %}

{% block title %}{{ problem.name }} ‚Äì CodeVerse{% endblock %}

{% block content %}

<div class="split-container">
  <!-- Problem description -->
  <div class="left-pane">
    <div class="problem-card">
      <div class="problem-card-title">
        <div class="problem-title-text">{{ problem.name }}</div>
        <div class="problem-card-meta">
          <div class="problem-card-meta-left">
            <div><strong>Code:</strong> <code>{{ problem.code }}</code></div>
            <div>
              <strong>Difficulty:</strong>
              <span class="badge 
                {% if problem.difficulty == 'Easy' %}bg-success text-light
                {% elif problem.difficulty == 'Medium' %}bg-warning text-dark
                {% elif problem.difficulty == 'Hard' %}bg-danger text-light
                {% else %}bg-secondary text-light{% endif %}">
                {{ problem.get_difficulty_display }}
              </span>
            </div>
          </div>
          <div class="problem-card-meta-right">
            <div><strong>Time:</strong> <span class="badge bg-info text-dark">{{ problem.time_limit }}s</span></div>
            <div><strong>Memory:</strong> <span class="badge bg-info text-dark">{{ problem.memory_limit }}MB</span></div>
          </div>
        </div>
      </div>
      
      <div class="problem-section">
        <h3>üìù Description</h3>
        <div class="markdown-body">{{ problem.description|safe }}</div>
      </div>
      
      <div class="problem-section">
        <h3>üîΩ Input Format</h3>
        <div class="markdown-body">{{ problem.input_format|safe }}</div>
      </div>
      
      <div class="problem-section">
        <h3>üîº Output Format</h3>
        <div class="markdown-body">{{ problem.output_format|safe }}</div>
      </div>
      
      <div class="problem-section">
        <h3>üìå Constraints</h3>
        <div class="markdown-body">{{ problem.constraints|safe }}</div>
      </div>
      
      <div class="problem-section">
        <h3>üîÇ Sample Input</h3>
        <div class="markdown-body">{{ problem.sample_input|safe }}</div>
      </div>
      
      <div class="problem-section">
        <h3>üîÅ Sample Output</h3>
        <div class="markdown-body">{{ problem.sample_output|safe }}</div>
      </div>
    </div>
  </div>

  <!-- Vertical splitter -->
  <div class="resizer" id="resizer"></div>

  <!-- Code workspace -->
  <div class="right-pane">
    <form id="submission-form" method="post">
      {% csrf_token %}
      
      <!-- Top controls - language selector and action buttons on same line -->
      <div class="top-controls">
        <div class="language-selector">
          <label for="language" style="color: #4da6ff; font-weight: 500;">Language:</label>
          <select name="language" id="language" class="form-select">
            <option value="cpp">C++</option>
            <option value="python">Python</option>
            <option value="java">Java</option>
            <option value="c">C</option>
          </select>
        </div>

        <!-- Action buttons -->
        <div class="action-buttons">
          <!-- AI Assist Button with Manual Dropdown -->
          <div class="dropdown ai-assist-dropdown">
            <button class="btn btn-outline-info" type="button" id="aiAssistBtn">
              ü§ñ AI Assist <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end" id="aiAssistMenu">
              <a class="dropdown-item ai-option" href="#" data-action="debugger">üõ†Ô∏è AI Debugger</a>
              <a class="dropdown-item ai-option" href="#" data-action="hints">üí° AI Hints</a>
              <a class="dropdown-item ai-option" href="#" data-action="explain">‚ùì Explain Question</a>
              <a class="dropdown-item ai-option" href="#" data-action="suggestions">‚ú® Suggestions</a>
            </div>
          </div>
          
          <button type="button" class="btn btn-outline-primary" id="run-button">
            ‚ñ∂Ô∏è Run Code
          </button>
          <button type="submit" class="btn btn-success">
            ‚úÖ Submit
          </button>
        </div>
      </div>

      <!-- IDE container -->
      <div class="ide-container">
        <div id="editor"></div>
        <textarea name="code" id="hidden-code" hidden></textarea>
      </div>

      <!-- Custom IO with tabs -->
      <div class="custom-io-container">
        <div class="custom-io-tabs">
          <button type="button" class="custom-io-tab active" data-tab="input">
            üì• Custom Input
          </button>
          <button type="button" class="custom-io-tab" data-tab="output">
            üì§ Custom Output
          </button>
        </div>
        
        <div class="custom-io-content">
          <!-- Custom Input Panel -->
          <div class="custom-io-panel active" id="input-panel">
            <div class="custom-io-single">
              <div class="io-section">
                <label>Enter your custom input:</label>
                <textarea id="custom-input" class="form-control" placeholder="Enter your custom input here...">{{ problem.sample_input|striptags|default:"" }}</textarea>
              </div>
            </div>
          </div>

          <!-- Custom Output Panel -->
          <div class="custom-io-panel" id="output-panel">
            <div class="custom-io-single">
              <div class="io-section">
                <label>Output will appear here:</label>
                <textarea id="custom-output" class="form-control" readonly placeholder="Output will appear here after running your code..."></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Monaco AMD Loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
<script src="{% static 'js/monaco-setup.js' %}"></script>

<style>
/* Custom dropdown styles to make it work properly */
.ai-assist-dropdown {
  position: relative;
}

.ai-assist-dropdown .dropdown-menu {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  z-index: 1000;
  min-width: 200px;
  background-color: #0e1c2e;
  border: 1px solid #4da6ff;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  margin-top: 2px;
}

.ai-assist-dropdown .dropdown-menu.show {
  display: block;
}

.ai-assist-dropdown .dropdown-item {
  display: block;
  width: 100%;
  padding: 8px 16px;
  color: #e2e8f0;
  text-decoration: none;
  background-color: transparent;
  border: 0;
  font-size: 14px;
  transition: all 0.15s ease-in-out;
}

.ai-assist-dropdown .dropdown-item:hover,
.ai-assist-dropdown .dropdown-item:focus {
  background-color: #1a2b4c;
  color: #ffffff;
}

.dropdown-arrow {
  font-size: 10px;
  margin-left: 5px;
  transition: transform 0.2s ease;
}

.dropdown-arrow.open {
  transform: rotate(180deg);
}

#aiAssistBtn {
  font-size: 14px;
  padding: 4px 10px;
  border-radius: 6px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Manual dropdown implementation
  const aiAssistBtn = document.getElementById('aiAssistBtn');
  const aiAssistMenu = document.getElementById('aiAssistMenu');
  const dropdownArrow = aiAssistBtn.querySelector('.dropdown-arrow');
  
  // Toggle dropdown
  aiAssistBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const isOpen = aiAssistMenu.classList.contains('show');
    
    // Close all other dropdowns (if any)
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
      menu.classList.remove('show');
    });
    
    // Toggle current dropdown
    if (isOpen) {
      aiAssistMenu.classList.remove('show');
      dropdownArrow.classList.remove('open');
    } else {
      aiAssistMenu.classList.add('show');
      dropdownArrow.classList.add('open');
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.ai-assist-dropdown')) {
      aiAssistMenu.classList.remove('show');
      dropdownArrow.classList.remove('open');
    }
  });
  
  // Handle dropdown item clicks
  document.querySelectorAll('.ai-option').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Close dropdown
      aiAssistMenu.classList.remove('show');
      dropdownArrow.classList.remove('open');
      
      // Get action
      const action = this.getAttribute('data-action');
      
      // Handle action
      handleAIAction(action);
    });
  });
  
  function handleAIAction(action) {
    const editor = window.monacoEditor; // We'll set this when Monaco loads
    const code = editor ? editor.getValue() : '';
    
    switch (action) {
      case 'debugger':
        console.log('üõ†Ô∏è AI Debugger clicked');
        alert('üõ†Ô∏è AI Debugger\nAnalyzing your code...\nCode length: ' + code.length);
        break;
      case 'hints':
        console.log('üí° AI Hints clicked');
        alert('üí° AI Hints\nHere are some hints based on your current code!');
        break;
      case 'explain':
        console.log('‚ùì Explain Question clicked');
        alert('‚ùì Explain Question\nProblem: {{ problem.name }}\nLet me explain this problem step by step...');
        break;
      case 'suggestions':
        console.log('‚ú® AI Suggestions clicked');
        alert('‚ú® AI Suggestions\nHere are some suggestions to improve your code!');
        break;
    }
  }

  // Tab switching functionality
  document.querySelectorAll('.custom-io-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.custom-io-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.custom-io-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const tabType = tab.dataset.tab;
      document.getElementById(tabType + '-panel').classList.add('active');
    });
  });

  // Monaco setup
  setupMonacoEditor({
    selector: "editor",
    language: "cpp",
    theme: "one-dark-pro",
    onReady: (editor, monaco) => {
      // Store editor reference globally for AI functions
      window.monacoEditor = editor;
      
      const boilerplate = {
        java: `import java.util.*;\n\npublic class Main {\n    public static void main(String[] args) {\n        // Your code here\n\n\n    }\n}`,
        python: `def main():\n    # Your code here\n\n\n    pass\n\nif __name__ == "__main__":\n    main()`,
        cpp: `#include <bits/stdc++.h>\nusing namespace std;\n\nint main() {\n    ios::sync_with_stdio(false);\n    cin.tie(nullptr);\n    // Your code here\n\n\n    return 0;\n}`,
        c: `#include <stdio.h>\n\nint main() {\n    // Your code here\n\n\n    return 0;\n}`
      };

      const langSel = document.getElementById("language");
      langSel.addEventListener("change", () => {
        const lang = langSel.value;
        editor.setValue(boilerplate[lang] || "");
        monaco.editor.setModelLanguage(editor.getModel(), lang === "cpp" ? "cpp" : lang);
      });
      langSel.dispatchEvent(new Event("change"));

      // Run button
      document.getElementById("run-button").addEventListener("click", () => {
        document.querySelectorAll('.custom-io-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.custom-io-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-tab="output"]').classList.add('active');
        document.getElementById('output-panel').classList.add('active');

        const data = new FormData();
        data.append("code", editor.getValue());
        data.append("language", langSel.value);
        data.append("custom_input", document.getElementById("custom-input").value);

        fetch("{% url 'run_code' %}", {
          method: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          body: data
        })
        .then(res => res.json())
        .then(json => {
          document.getElementById("custom-output").value =
            json.output || json.details || json.error || "";
        });
      });

      // Set default input
      setTimeout(() => {
        const customInputField = document.getElementById("custom-input");
        if (customInputField && !customInputField.value) {
          customInputField.value = "{{ problem.sample_input|striptags|default:""|escapejs }}";
        }
      }, 100);

      // Submission - sync hidden textarea
      document.getElementById("submission-form").addEventListener("submit", () => {
        document.getElementById("hidden-code").value = editor.getValue();
      });
    }
  });

  // Resizer logic
  const rz = document.getElementById("resizer"),
        lp = rz.previousElementSibling;
  let dragging = false;

  rz.onmousedown = () => {
    dragging = true;
    document.body.style.cursor = "ew-resize";
  };

  document.onmousemove = e => {
    if (!dragging) return;
    let newW = e.clientX - lp.parentNode.offsetLeft;
    if (newW > 250 && newW < window.innerWidth * 0.7) {
      lp.style.width = newW + "px";
    }
  };

  document.onmouseup = () => {
    dragging = false;
    document.body.style.cursor = "";
  };
});
</script>

{% endblock %}